<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Retail Insights</title>
    <link rel="stylesheet" href="shared-styles.css">
</head>
<body>
    <!-- Top Navigation Header -->
    <div class="top-header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon">üìä</div>
                <div class="brand-name">Retail Insights</div>
            </div>
            
            <nav class="nav-menu">
                <a href="dashboard.html" class="nav-item active">Dashboard</a>
                <a href="inventoryhealth.html" class="nav-item">Inventory</a>
                <a href="forecasttrends.html" class="nav-item">Demand Forecast</a>
                <a href="recommendation.html" class="nav-item">Recommendations</a>
                <a href="purchaseorders.html" class="nav-item">Purchase Orders</a>
                <a href="cart.html" class="nav-item">Shopping Cart</a>
            </nav>
            
            <div class="header-actions">
                <div class="notification-bell">
                    üîî
                    <div class="notification-badge"></div>
                </div>
                <a href="profile.html"><div class="user-avatar" id ="userAvatar">A</div></a>
                <a href="settings.html"><div class="settings-icon">S</div></a>
            </div>

        </div>
    </div>

    <div class="container">
        <!-- Original Dashboard Header -->
        <div class="original-header">
            <div class="welcome">
                <h1 id="welcomeMessage">Welcome to Dashboard!</h1>
                <p>Manage your account and view your activity</p>
            </div>
            
        </div>

        <div id="alert" class="alert"></div>
        <div id="loading" class="loading"></div>

        <!-- Original Dashboard Grid -->
        
           
            <!-- Statistics Card -->
          
        <!-- New Retail Dashboard Section -->
        <div class="page-title">
            <h2>Dashboard</h2>
        </div>

        <!-- Alert Notifications -->
        <div class="alert-section">
            <div class="alert-card alert-warning">
                <div class="alert-content">
                    <div class="alert-icon">‚ö†Ô∏è</div>
                    <div class="alert-text">
                        <h4>12 items at risk of stockout</h4>
                        <p>Take action now to prevent lost sales.</p>
                    </div>
                </div>
                <button class="alert-action" onclick="window.location.href='inventory.html'">View Details</button>
            </div>
            
            <div class="alert-card alert-success">
                <div class="alert-content">
                    <div class="alert-icon">üí∞</div>
                    <div class="alert-text">
                        <h4>Save ‚Çπ15,000 by reordering smartly</h4>
                        <p>Your efficient reordering strategy is paying off.</p>
                    </div>
                </div>
                <button class="alert-action" onclick="window.location.href='recommendations.html'">View Savings</button>
            </div>
        </div>

        <!-- Key Metrics Section -->
        <div class="metrics-section">
            <h3>Key Metrics</h3>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Current Stock Value</div>
                    <div class="metric-value metric-currency">‚Çπ1,20,000</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-label">Forecasted Demand (7 days)</div>
                    <div class="metric-value metric-units">250 units</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-label">Stockouts avoided this week</div>
                    <div class="metric-value metric-count">5</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-label">Inventory turnover</div>
                    <div class="metric-value metric-ratio">2.5x</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div class="footer-links">
            <a href="#" class="footer-link">Privacy Policy</a>
            <a href="#" class="footer-link">Terms of Service</a>
            <a href="#" class="footer-link">Contact Us</a>
        </div>
        <div class="copyright">¬© 2024 Retail Insights. All rights reserved.</div>
    </div>

    <script>
        let currentUser = null;

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('authToken');
            
            if (!token) {
                // Comment out for testing
                // window.location.href = '/login';
                // return;
            }

            loadUserData();
            updateUserAvatar();
        });

        function updateUserAvatar() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const avatar = document.getElementById('userAvatar');
            if (user.name) {
                avatar.textContent = user.name.charAt(0).toUpperCase();
            }
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        function hideAlert() {
            document.getElementById('alert').style.display = 'none';
        }

        async function loadUserData() {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';

            try {
                // For testing without backend
                const mockUser = {
                    name: 'John Doe',
                    email: 'john@example.com',
                    _id: 'user123',
                    createdAt: new Date().toISOString()
                };
                
                currentUser = mockUser;
                updateUserInterface();
                showAlert('Dashboard loaded successfully!', 'info');
                
            } catch (error) {
                console.error('Error loading user data:', error);
                showAlert('Failed to load user data. Using demo data.', 'error');
            } finally {
                loading.style.display = 'none';
            }
        }

        function updateUserInterface() {
            if (!currentUser) return;

            const userRole = 'retailer';

            // Update welcome message
            document.getElementById('welcomeMessage').textContent = `Welcome back, ${currentUser.name}!`;
            
            // Update user info
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userRole').textContent = userRole.charAt(0).toUpperCase() + userRole.slice(1);
            document.getElementById('userId').textContent = currentUser._id;
            
            // Update joined date
            const joinedDate = new Date(currentUser.createdAt);
            document.getElementById('userJoined').textContent = joinedDate.toLocaleDateString();
            
            // Update statistics
            const daysSinceJoined = Math.floor((new Date() - joinedDate) / (1000 * 60 * 60 * 24));
            document.getElementById('daysSinceJoined').textContent = daysSinceJoined;
            document.getElementById('loginCount').textContent = Math.floor(Math.random() * 50) + 1;
            document.getElementById('lastLoginDays').textContent = '0';
        }

        async function refreshData() {
            hideAlert();
            await loadUserData();
            showAlert('Data refreshed successfully!', 'info');
        }

        async function testApiConnection() {
            showAlert('API connection test - Demo mode', 'info');
        }

        function downloadUserData() {
            if (!currentUser) {
                showAlert('No user data available', 'error');
                return;
            }

            const userData = {
                user: currentUser,
                role: 'retailer',
                exported: new Date().toISOString(),
                stats: {
                    memberSince: currentUser.createdAt,
                    daysMember: Math.floor((new Date() - new Date(currentUser.createdAt)) / (1000 * 60 * 60 * 24))
                }
            };

            const dataStr = JSON.stringify(userData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `user-data-${currentUser.name.replace(/\s+/g, '-')}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('User data downloaded successfully!', 'info');
        }

        function clearLocalData() {
            if (confirm('Are you sure you want to clear all local data?')) {
                localStorage.clear();
                showAlert('Local data cleared!', 'info');
            }
        }

        function showTokenInfo() {
            const token = localStorage.getItem('authToken') || 'demo-token-123';
            alert(`Token Info: ${token.substring(0, 20)}...`);
        }

        async function logout() {
            if (!confirm('Are you sure you want to logout?')) {
                return;
            }

            localStorage.clear();
            showAlert('Logged out successfully!', 'info');
            
            setTimeout(() => {
                window.location.href = '/';
            }, 1500);
        }
    </script>
</body>
</html>